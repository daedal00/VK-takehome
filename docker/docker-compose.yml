# Docker Compose configuration for Async Data Pipeline
# Orchestrates 3 mock API servers and the pipeline application

services:
  # Mock API Server 1
  mock-server-1:
    build:
      context: ..
      dockerfile: docker/Dockerfile
    command: [".venv/bin/python", "-m", "uvicorn", "src.mock_servers.app:create_app", "--factory", "--host", "0.0.0.0", "--port", "8001"]
    environment:
      - SERVER_NAME=api1
      - SERVER_PORT=8001
      - RANDOM_SEED=42
      - ERROR_RATE=0.1
      - EXTRA_LATENCY_MS=0
      - PAGES=5
      - ITEMS_PER_PAGE=20
    ports:
      - "8001:8001"
    healthcheck:
      test: ["CMD", "python", "-c", "import urllib.request; urllib.request.urlopen('http://localhost:8001/health')"]
      interval: 5s
      timeout: 3s
      retries: 3
      start_period: 10s
    networks:
      - pipeline-network

  # Mock API Server 2
  mock-server-2:
    build:
      context: ..
      dockerfile: docker/Dockerfile
    command: [".venv/bin/python", "-m", "uvicorn", "src.mock_servers.app:create_app", "--factory", "--host", "0.0.0.0", "--port", "8002"]
    environment:
      - SERVER_NAME=api2
      - SERVER_PORT=8002
      - RANDOM_SEED=43
      - ERROR_RATE=0.1
      - EXTRA_LATENCY_MS=0
      - PAGES=5
      - ITEMS_PER_PAGE=20
    ports:
      - "8002:8002"
    healthcheck:
      test: ["CMD", "python", "-c", "import urllib.request; urllib.request.urlopen('http://localhost:8002/health')"]
      interval: 5s
      timeout: 3s
      retries: 3
      start_period: 10s
    networks:
      - pipeline-network

  # Mock API Server 3
  mock-server-3:
    build:
      context: ..
      dockerfile: docker/Dockerfile
    command: [".venv/bin/python", "-m", "uvicorn", "src.mock_servers.app:create_app", "--factory", "--host", "0.0.0.0", "--port", "8003"]
    environment:
      - SERVER_NAME=api3
      - SERVER_PORT=8003
      - RANDOM_SEED=44
      - ERROR_RATE=0.1
      - EXTRA_LATENCY_MS=0
      - PAGES=5
      - ITEMS_PER_PAGE=20
    ports:
      - "8003:8003"
    healthcheck:
      test: ["CMD", "python", "-c", "import urllib.request; urllib.request.urlopen('http://localhost:8003/health')"]
      interval: 5s
      timeout: 3s
      retries: 3
      start_period: 10s
    networks:
      - pipeline-network

  # Pipeline Application
  pipeline:
    build:
      context: ..
      dockerfile: docker/Dockerfile
    command: [".venv/bin/python", "-m", "src.pipeline.main", "--no-progress", "--log-level", "INFO"]
    environment:
      - PIPELINE_TIMEOUT=60
      - PIPELINE_RATE_LIMIT_RPS=5
      - PIPELINE_WORKER_POOL_SIZE=4
      - PIPELINE_LOG_LEVEL=INFO
    volumes:
      - ./out:/app/out
    depends_on:
      mock-server-1:
        condition: service_healthy
      mock-server-2:
        condition: service_healthy
      mock-server-3:
        condition: service_healthy
    networks:
      - pipeline-network

networks:
  pipeline-network:
    driver: bridge
